<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS C4 - Dashboard</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/components.css">

    <!-- LIBRERÍAS PARA PDF Y SOCKETS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // VERIFICACIÓN DE SESIÓN MEJORADA (Gatekeeper)
        (function () {
            function checkSession() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');

                if (!token || !user) {
                    window.location.replace('index.html');
                }
            }

            // Ejecutar al cargar y al volver atrás (bfcache)
            window.addEventListener('pageshow', function (event) {
                checkSession();
            });

            checkSession();
        })();
    </script>
</head>

<body>

    <div id="app-container" class="app-container">
        <!-- HEADER CON NAVBAR ESTILO DASHBOARD -->
        <header>
            <div class="container header-container">
                <div class="header-content">
                    <!-- LOGO -->
                    <div class="logo">
                        <i class="fas fa-shield-alt"></i>
                        <h1>SAS C4 - Bitácora</h1>
                    </div>

                    <!-- NAVBAR -->
                    <nav id="main-nav">
                        <ul>
                            <li><a href="#" id="nav-dashboard">Dashboard</a></li>
                            <li><a href="#" id="nav-llamadas">Registrar</a></li>

                            <li><a href="#" id="nav-mapacalor">Mapa</a></li>
                            <li><a href="#" id="nav-c5">Enviar a C5</a></li>
                        </ul>
                    </nav>

                    <div class="header-actions">
                        <!-- INFO USUARIO -->
                        <div id="user-info">

                            <span id="user-name">Cargando...</span>
                        </div>

                        <!-- BOTÓN SALIR -->
                        <a href="#" id="logout-btn"><span>Salir</span></a>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTENIDO PRINCIPAL -->
        <main>
            <div class="container">
                <div id="content">
                    <!-- App.js cargará las vistas aquí -->
                    <div class="loading-container">

                        <p>Cargando sistema operativo...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- FOOTER INSTITUCIONAL - POSICIONADO EN LA PARTE INFERIOR -->
        <div class="institutional-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-details">
                        <span id="copyright-text">© 2024 Sistema de Gestión de Emergencias</span>
                        <span class="footer-divider">•</span>
                        <span class="beta-badge">BETA 2.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS DE CONFIGURACIÓN -->
    <script src="js/config/app.config.js"></script>

    <!-- SCRIPTS DE UTILIDADES -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/api.js"></script>
    <script src="js/utils/formatters.js"></script>
    <script src="js/utils/notifications.js"></script>
    <script src="js/utils/exporters.js"></script>
    <script src="js/utils/printManager.js"></script>

    <!-- SCRIPTS DE COMPONENTES UI -->
    <script src="js/components/ToastNotifications.js"></script>
    <script src="js/components/ModalManager.js"></script>
    <script src="js/components/LoadingOverlay.js"></script>
    <script src="js/components/ConfirmDialog.js"></script>

    <!-- SCRIPTS DE SERVICIOS -->
    <script src="js/services/LlamadasService.js"></script>
    <script src="js/services/C5Service.js"></script>

    <!-- SCRIPTS DE VISTAS -->
    <script src="js/views/DashboardView.js"></script>
    <script src="js/views/MapaCalorView.js"></script>
    <script src="js/views/LlamadasView.js"></script>

    <script src="js/views/LoginView.js"></script>

    <script src="js/views/c5/C5MainView.js"></script>
    <script src="js/views/c5/C5NewView.js"></script>
    <script src="js/views/c5/C5ListView.js"></script>
    <script src="js/views/c5/C5SuccessView.js"></script>
    <script src="js/views/c5/C5DetailsView.js"></script>
    <script src="js/views/C5View.js"></script>

    <!-- APP.JS ÚLTIMO -->
    <script src="js/app.js"></script>

    <!-- SCRIPT PARA INICIALIZAR FOOTER Y USUARIO -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. Actualizar nombre de usuario
            const user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    const userName = userData.nombre || userData.username || 'Operador';
                    const userTurno = userData.turno || 'General';

                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) {
                        userNameEl.textContent = `${userName} | Turno ${userTurno}`;
                    }
                } catch (e) {
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) {
                        userNameEl.textContent = 'Operador';
                    }
                }
            }

            // 2. Actualizar año de copyright
            const currentYear = new Date().getFullYear();
            const copyrightEl = document.getElementById('copyright-text');
            if (copyrightEl) {
                copyrightEl.textContent =
                    `Sistema de Gestión de Emergencias © ${currentYear} - Todos los derechos reservados`;
            }

            // 3. Manejar botón de logout
            document.getElementById('logout-btn')?.addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.replace('index.html');
            });

            // 4. Manejar navegación (si app.js no está cargado)
            document.getElementById('nav-dashboard')?.addEventListener('click', function (e) {
                e.preventDefault();
                if (window.app && window.app.loadView) {
                    window.app.loadView('dashboard');
                }
            });

            document.getElementById('nav-llamadas')?.addEventListener('click', function (e) {
                e.preventDefault();
                if (window.app && window.app.loadView) {
                    window.app.loadView('llamadas');
                }
            });



            document.getElementById('nav-c5')?.addEventListener('click', function (e) {
                e.preventDefault();
                if (window.app && window.app.loadView) {
                    window.app.loadView('c5');
                }
            });

            // 5. Ajustar altura del contenido cuando se carga
            function adjustContentHeight() {
                const content = document.getElementById('content');
                const main = document.querySelector('main');

                if (content.children.length > 1 || content.innerHTML.includes('dashboard') ||
                    content.innerHTML.includes('view')) {
                    content.classList.add('loaded');
                    main.style.minHeight = 'auto';
                }
            }

            // Verificar cada segundo si se cargó contenido
            setTimeout(adjustContentHeight, 1000);
            setInterval(adjustContentHeight, 3000);
        });
    </script>

</body>

</html>